{% extends "repairs/base.html" %}
{% block title %}Календарь — {{ model.brand.name }} {{ model.name }}{% endblock %}

{% block content %}
{% now "Y-m-d" as today_iso %}
{% now "Y-m" as ym_now %}

<style>
  /* ====== КАЛЕНДАРЬ ====== */
  #cal{
    --gap:12px; --r:14px; --brd:#e5e7eb; --muted:#64748b;
    --ink:#0f172a; --ok:#10b981; --accent:#111; --bg:#fff; --hl:#f0fdfa;
  }
  #cal .toolbar{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:8px
  }
  #cal .toolbar h1{margin:0;font-size:20px}
  #cal .btn{
    display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;
    border:1px solid var(--brd);background:#fff;color:#111;text-decoration:none
  }
  #cal .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  #cal .btn[aria-disabled="true"]{opacity:.5;pointer-events:none}
  #cal .btn:hover{opacity:.95}
  #cal .toolbar .group{display:flex;gap:8px;align-items:center}

  /* Сетки */
  #cal .grid{display:grid;gap:var(--gap)}
  #cal .dow-row{grid-template-columns:repeat(7,1fr)}
  #cal .cal-days{grid-template-columns:repeat(7,1fr)}

  #cal .dow{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}

  /* Ячейки */
  #cal .cell{
    background:var(--bg);border:1px solid var(--brd);border-radius:var(--r);
    min-height:120px;padding:10px;display:flex;flex-direction:column;gap:8px
  }
  #cal .cell .top{display:flex;justify-content:space-between;align-items:center}
  #cal .cell.has-slots{background:var(--hl)}
  #cal .num{font-weight:700; display:flex; align-items:center; gap:6px}
  #cal .badge{font-size:12px;color:var(--muted)}
  #cal .badge.ok{color:var(--ok)}
  #cal .badge.zero{color:var(--muted)}
  #cal .out{opacity:.55}
  #cal .weekend{background:linear-gradient(0deg, rgba(249,250,251,.9), rgba(255,255,255,1))}
  #cal .today{border-color:#111; box-shadow:0 0 0 2px rgba(0,0,0,.05) inset}

  /* Плейсхолдер — полностью исключён из потока */
  #cal .cell.cell--placeholder{ display:none; }

  /* Слоты */
  #cal .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:auto}
  #cal .chip{
    display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;
    background:#111;color:#fff;text-decoration:none;font-size:14px;white-space:nowrap
  }
  #cal .chip:hover{opacity:.95}
  #cal .chip.ghost{background:#fff;color:var(--ink);border:1px solid var(--brd)}
  #cal .chip.more{background:#fff;color:var(--ink);border:1px dashed var(--brd)}
  #cal .chip svg{width:18px;height:18px}

  /* Десктоп: показываем до 6 слотов */
  #cal .chips .slot-chip:nth-child(n+7){display:none}
  #cal .chips.expanded .slot-chip{display:inline-flex}
  #cal .chips.expanded .more{display:none}

  /* Мобильная метка дня недели внутри числа */
  #cal .wday-mobile{
    display:none; font-size:11px; color:var(--muted);
    text-transform:uppercase; letter-spacing:.03em;
  }

  /* ====== АДАПТИВ ====== */
  @media (max-width: 760px){
    #cal .toolbar{flex-wrap:wrap}
    #cal .toolbar h1{font-size:18px;order:3;width:100%;text-align:center}
    #cal .btn{padding:6px 10px;font-size:14px}

    /* прячем заголовки дней недели */
    #cal .dow-row{display:none}

    /* мобильная метка дня недели включается */
    #cal .wday-mobile{display:inline-block}

    /* компактнее карточки; сетка — 2 колонки */
    #cal .cell{min-height:105px;padding:8px}
    #cal .chip{font-size:13px;padding:5px 9px}
    #cal .chip svg{width:16px;height:16px}

    #cal .cal-days{grid-template-columns:repeat(2,1fr);gap:10px}

    /* на мобильном до 4 слотов до раскрытия */
    #cal .chips .slot-chip:nth-child(n+5){display:none}

    /* при раскрытии показать все слоты, перекрывая nth-child */
    #cal .chips.expanded .slot-chip{display:inline-flex !important;}
    #cal .chips.expanded .more{display:none !important;}
  }

  @media (max-width: 420px){
    #cal .cal-days{grid-template-columns:1fr}
  }
</style>

<div id="cal">
  <p>
    <a class="btn" href="{% url 'repairs:repair_list' brand_slug=model.brand.slug model_slug=model.slug %}">
      ← Назад к услугам
    </a>
  </p>

  <div class="toolbar">
    <div class="group">
      {% if can_prev %}
        <a class="btn" href="?month={{ prev_month|date:'Y-m' }}">← Предыдущий</a>
      {% else %}
        <span class="btn" aria-disabled="true">← Предыдущий</span>
      {% endif %}
    </div>

    <h1>{{ month_start|date:"F Y" }}</h1>

    <div class="group">
      <a class="btn" href="?month={{ ym_now }}">Сегодня</a>
      {% if can_next %}
        <a class="btn" href="?month={{ next_month|date:'Y-m' }}">Следующий →</a>
      {% else %}
        <span class="btn" aria-disabled="true">Следующий →</span>
      {% endif %}
    </div>
  </div>

  <!-- Заголовки дней недели -->
  <div class="grid dow-row" style="margin-bottom:8px">
    <div class="dow">Пн</div><div class="dow">Вт</div><div class="dow">Ср</div>
    <div class="dow">Чт</div><div class="dow">Пт</div><div class="dow">Сб</div><div class="dow">Вс</div>
  </div>

  <!-- Сетка -->
  <div class="grid cal-days">
    {% for week in weeks %}
      {% for day in week %}
        {% with w=day.date|date:"w" %}
          <div class="cell
                      {% if day.placeholder %} cell--placeholder{% endif %}
                      {% if not day.in_month %} out{% endif %}
                      {% if day.date|date:'Y-m-d' == today_iso %} today{% endif %}
                      {% if w == '0' or w == '6' %} weekend{% endif %}
                      {% if day.slots %} has-slots{% endif %}">
            <div class="top">
              <div class="num">
                <span class="wday-mobile">
                  {% if w == '1' %}Пн{% elif w == '2' %}Вт{% elif w == '3' %}Ср
                  {% elif w == '4' %}Чт{% elif w == '5' %}Пт{% elif w == '6' %}Сб
                  {% else %}Вс{% endif %}
                </span>
                {{ day.date.day }}
              </div>
              <span class="badge {% if day.slots %}ok{% else %}zero{% endif %}">
                {% if day.slots %}{{ day.slots|length }} слотов{% else %}нет слотов{% endif %}
              </span>
            </div>

            {% if day.slots %}
              <div class="chips" id="chips-{{ day.date|date:'Ymd' }}">
                {% for s in day.slots %}
                  <a class="chip slot-chip"
                     href="{% url 'repairs:book' brand_slug=model.brand.slug model_slug=model.slug repair_slug=repair_type.slug %}?slot={{ s|date:'c'|urlencode }}">
                    {{ s|date:"H:i" }}
                  </a>
                {% endfor %}
                <button type="button" class="chip more" data-target="chips-{{ day.date|date:'Ymd' }}" hidden>+ ещё</button>
              </div>
            {% else %}
              <div class="chips">
                <span class="chip ghost" aria-disabled="true">Недоступно</span>
              </div>
            {% endif %}
          </div>
        {% endwith %}
      {% endfor %}
    {% endfor %}
  </div>

  <p class="small" style="margin-top:10px;color:#64748b">
    Модель: {{ model.brand.name }} {{ model.name }} • {{ repair_type.name }}
  </p>
  {% if limit_date %}
    <p class="small" style="margin-top:4px;color:#64748b">
      Доступна запись до {{ limit_date|date:"d.m.Y" }}.
    </p>
  {% endif %}
</div>
<script>
  // Выравниваем высоты ячеек под самую высокую (без скрытых плейсхолдеров)
  function updateCellHeights() {
    const cells = document.querySelectorAll('#cal .cal-days .cell');
    let maxH = 0;
    cells.forEach(c => {
      if (c.classList.contains('cell--placeholder')) return;
      c.style.minHeight = '';
      maxH = Math.max(maxH, c.offsetHeight);
    });
    cells.forEach(c => {
      if (c.classList.contains('cell--placeholder')) return;
      c.style.minHeight = maxH + 'px';
    });
  }

  // Считать, сколько слотов скрыто (из-за nth-child на текущей ширине),
  // и обновить текст/видимость кнопки "+ ещё N"
  function updateMoreButtons() {
    document.querySelectorAll('#cal .chips').forEach(box => {
      const btn = box.querySelector('.chip.more');
      if (!btn) return;

      if (box.classList.contains('expanded')) {
        btn.hidden = true;
        return;
      }

      const hidden = Array.from(box.querySelectorAll('.slot-chip'))
        .filter(el => getComputedStyle(el).display === 'none').length;

      if (hidden > 0) {
        btn.textContent = `+ ещё ${hidden}`;
        btn.hidden = false;
      } else {
        btn.hidden = true;
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateMoreButtons();
    updateCellHeights();
  });
  window.addEventListener('resize', () => {
    updateMoreButtons();
    updateCellHeights();
  });

  // Раскрытие «ещё N»
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.chip.more');
    if(!btn) return;
    const id = btn.getAttribute('data-target');
    const box = document.getElementById(id);
    if(box){
      box.classList.add('expanded');
      updateMoreButtons();
      updateCellHeights();
    }
  }, {passive:true});
</script>
{% endblock %}
