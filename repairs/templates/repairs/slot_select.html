{% extends "repairs/base.html" %}
{% block title %}Календарь — {{ model.brand.name }} {{ model.name }}{% endblock %}

{% block content %}
{% now "Y-m-d" as today_iso %}
{% now "Y-m" as ym_now %}

<style>
  /* Тема календаря */
  #cal{
    --gap:12px; --r:14px; --brd:#e5e7eb; --muted:#64748b;
    --ink:#0f172a; --ok:#10b981; --accent:#111; --bg:#fff
  }
  #cal .toolbar{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:8px
  }
  #cal .toolbar h1{margin:0;font-size:20px}
  #cal .btn{
    display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;
    border:1px solid var(--brd);background:#fff;color:#111;text-decoration:none
  }
  #cal .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  #cal .btn:hover{opacity:.95}
  #cal .toolbar .group{display:flex;gap:8px;align-items:center}

  /* Сетки */
  #cal .grid{display:grid;gap:var(--gap)}
  #cal .dow-row{grid-template-columns:repeat(7,1fr)}
  #cal .cal-days{grid-template-columns:repeat(7,1fr)}

  #cal .dow{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}

  #cal .cell{
    background:var(--bg);border:1px solid var(--brd);border-radius:var(--r);
    min-height:120px;padding:10px;display:flex;flex-direction:column;gap:8px
  }
  #cal .cell .top{display:flex;justify-content:space-between;align-items:center}
  #cal .num{font-weight:700; display:flex; align-items:center; gap:6px}
  #cal .badge{font-size:12px;color:var(--muted)}
  #cal .badge.ok{color:var(--ok)}
  #cal .badge.zero{color:var(--muted)}
  #cal .out{opacity:.55}
  #cal .weekend{background:linear-gradient(0deg, rgba(249,250,251,.9), rgba(255,255,255,1))}
  #cal .today{border-color:#111; box-shadow:0 0 0 2px rgba(0,0,0,.05) inset}

  /* Чипы слотов */
  #cal .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:auto}
  #cal .chip{
    display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;
    background:#111;color:#fff;text-decoration:none;font-size:14px;white-space:nowrap
  }
  #cal .chip:hover{opacity:.95}
  #cal .chip.ghost{background:#fff;color:var(--ink);border:1px solid var(--brd)}
  #cal .chip.more{background:#fff;color:var(--ink);border:1px dashed var(--brd)}
  #cal .chip svg{width:18px;height:18px}

  /* desktop: показываем 4 слота, остальное — под «ещё N» */
  #cal .chips .slot-chip:nth-child(n+5){display:none}
  #cal .chips.expanded .slot-chip{display:inline-flex}
  #cal .chips.expanded .more{display:none}

  /* Метка дня недели для мобилок (внутри числа) */
  #cal .wday-mobile{
    display:none; font-size:11px; color:var(--muted);
    text-transform:uppercase; letter-spacing:.03em;
  }

  /* ====== АДАПТИВ ====== */
  @media (max-width: 760px){
    #cal .toolbar{flex-wrap:wrap}
    #cal .toolbar h1{font-size:18px;order:3;width:100%;text-align:center}
    #cal .btn{padding:6px 10px;font-size:14px}

    /* прячем заголовок с днями недели */
    #cal .dow-row{display:none}

    /* мобильная метка дня недели включается */
    #cal .wday-mobile{display:inline-block}

    /* уменьшаем отступы, чипы, и делаем 2 колонки */
    #cal .cell{min-height:105px;padding:8px}
    #cal .chip{font-size:13px;padding:5px 9px}
    #cal .chip svg{width:16px;height:16px}

    #cal .cal-days{grid-template-columns:repeat(2,1fr);gap:10px}

    /* на мобильном показываем 3 слота до раскрытия */
    #cal .chips .slot-chip:nth-child(n+4){display:none}
  }

  /* очень узкие экраны — по 1 колонке */
  @media (max-width: 420px){
    #cal .cal-days{grid-template-columns:1fr}
  }
</style>

<div id="cal">
  <p>
    <a class="btn" href="{% url 'repairs:repair_list' brand_slug=model.brand.slug model_slug=model.slug %}">
      <svg viewBox="0 0 24 24" fill="none" width="18" height="18" aria-hidden="true">
        <path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Назад к услугам
    </a>
  </p>

  <div class="toolbar">
    <div class="group">
      <a class="btn" href="?month={{ prev_month|date:'Y-m' }}">
        <svg viewBox="0 0 24 24" fill="none" width="18" height="18" aria-hidden="true">
          <path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Предыдущий
      </a>
    </div>

    <h1>{{ month_start|date:"F Y" }}</h1>

    <div class="group">
      <a class="btn" href="?month={{ ym_now }}">Сегодня</a>
      <a class="btn" href="?month={{ next_month|date:'Y-m' }}">
        Следующий
        <svg viewBox="0 0 24 24" fill="none" width="18" height="18" aria-hidden="true">
          <path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
  </div>

  <!-- Заголовки дней недели (скрываются на мобилках) -->
  <div class="grid dow-row" style="margin-bottom:8px">
    <div class="dow">Пн</div><div class="dow">Вт</div><div class="dow">Ср</div>
    <div class="dow">Чт</div><div class="dow">Пт</div><div class="dow">Сб</div><div class="dow">Вс</div>
  </div>

  <!-- 6×7 ячеек -->
  <div class="grid cal-days">
    {% for week in weeks %}
      {% for day in week %}
        {% with w=day.date|date:"w" %}
        <div class="cell
                    {% if not day.in_month %} out{% endif %}
                    {% if day.date|date:'Y-m-d' == today_iso %} today{% endif %}
                    {% if w == '6' or w == '0' %} weekend{% endif %}">
          <div class="top">
            <div class="num">
              <span class="wday-mobile">
                {% if w == '1' %}Пн{% elif w == '2' %}Вт{% elif w == '3' %}Ср
                {% elif w == '4' %}Чт{% elif w == '5' %}Пт{% elif w == '6' %}Сб
                {% else %}Вс{% endif %}
              </span>
              {{ day.date.day }}
            </div>
            <span class="badge {% if day.slots %}ok{% else %}zero{% endif %}">
              {% if day.slots %}{{ day.slots|length }} слотов{% else %}нет слотов{% endif %}
            </span>
          </div>

          {% if day.slots %}
            {% with total=day.slots|length more=day.slots|length|add:"-4" %}
            <div class="chips" id="chips-{{ day.date|date:'Ymd' }}">
              {% for s in day.slots %}
                <a class="chip slot-chip"
                   href="{% url 'repairs:book' brand_slug=model.brand.slug model_slug=model.slug repair_slug=repair_type.slug %}?slot={{ s|date:'c'|urlencode }}">
                  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 7v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  {{ s|date:"H:i" }}
                </a>
              {% endfor %}

              {% if total > 4 %}
                <button type="button" class="chip more" data-target="chips-{{ day.date|date:'Ymd' }}">+ ещё {{ more }}</button>
              {% endif %}
            </div>
            {% endwith %}
          {% else %}
            <div class="chips">
              <span class="chip ghost" aria-disabled="true">Недоступно</span>
            </div>
          {% endif %}
        </div>
        {% endwith %}
      {% endfor %}
    {% endfor %}
  </div>

  <p style="margin-top:16px;color:#64748b">
    Модель: {{ model.brand.name }} {{ model.name }} • {{ repair_type.name }}
  </p>
</div>

<script>
  // Раскрытие "ещё N" слотов
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.chip.more');
    if(!btn) return;
    const id = btn.getAttribute('data-target');
    const box = document.getElementById(id);
    if(box){ box.classList.add('expanded'); }
  }, {passive:true});
</script>
{% endblock %}
