{% extends "repairs/base.html" %}
{% block title %}Отчёт по партнёрам{% endblock %}
{% block content %}
<h1>Отчёт по партнёрам</h1>

<form method="get" style="display:flex;gap:12px;flex-wrap:wrap;align-items:end;margin:12px 0">
  <label>С даты<br><input type="date" name="from" value="{{ date_from|date:'Y-m-d' }}"></label>
  <label>По дату<br><input type="date" name="to" value="{{ date_to|date:'Y-m-d' }}"></label>

  {% if has_status %}
    <label>Статус<br>
      <select name="status">
        <option value="" {% if not status %}selected{% endif %}>Все</option>
        <option value="pending" {% if status == 'pending' %}selected{% endif %}>Ожидает</option>
        <option value="accrued" {% if status == 'accrued' %}selected{% endif %}>Начислено</option>
        <option value="paid" {% if status == 'paid' %}selected{% endif %}>Выплачено</option>
      </select>
    </label>
  {% endif %}

  <button class="btn" type="submit">Показать</button>
</form>

<table class="table">
  <thead>
    <tr>
      <th>Партнёр</th>
      <th>Код</th>
      <th>Кол-во</th>
      <th>Скидка, BYN</th>
      <th>Комиссия, BYN</th>
      {% if has_status %}
        <th>Ожидает</th>
        <th>Начислено</th>
        <th>Выплачено</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
      <tr>
        <td>
          <a href="{% url 'repairs:referrals_partner_report' code=r.partner__code %}?from={{ date_from|date:'Y-m-d' }}&to={{ date_to|date:'Y-m-d' }}{% if status %}&status={{ status }}{% endif %}">
            {{ r.partner__name }}
          </a>
        </td>
        <td><code>{{ r.partner__code }}</code></td>
        <td>{{ r.uses|default:0 }}</td>
        <td>{{ r.total_discount|default:0 }}</td>
        <td>{{ r.total_commission|default:0 }}</td>
        {% if has_status %}
          <td>{{ r.pending_commission|default:0 }}</td>
          <td>{{ r.accrued_commission|default:0 }}</td>
          <td>{{ r.paid_commission|default:0 }}</td>
        {% endif %}
      </tr>
    {% empty %}
      <tr><td colspan="{% if has_status %}8{% else %}5{% endif %}" class="muted">Нет данных за выбранный период</td></tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="2">ИТОГО</th>
      <th>{{ totals.total_uses|default:0 }}</th>
      <th>{{ totals.total_discount|default:0 }}</th>
      <th>{{ totals.total_commission|default:0 }}</th>
      {% if has_status %}<th colspan="3"></th>{% endif %}
    </tr>
  </tfoot>
</table>
{% endblock %}
